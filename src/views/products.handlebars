<style>
    body {
        background-color: #333;
    }

    .login-container {
        max-width: 360px;
        margin: auto;
        margin-top: 64px;
        padding: 32px;
        border-radius: 0.5em;
        color: #333;
        border: 1px solid #bbb;
        background-color: #ccc;
    }

    .a2 {
        color: #333;
    }

    .a2:hover {
        color: #000;
    }

</style>


<div>
    <h1>Lista de productos</h1>
    <h3>Bienvenido, {{user.firstName}} {{user.lastName}} ({{user.role}})</h3>
    <h3>Datos del usuario: {{user}}</h3>
    <form action="/api/auth/logout" method="get">
    <button type="submit" class="btn btn-success">Salir</button>

    <button onclick="createCart()">Crear Carrito</button>

</form>
    <ul class="list-group" id="product-list">
        {{#if products}}
            {{#each products}}
                <li class="list-group-item">
                    <h3>{{title}}</h3>
                    <img src="{{thumbnail}}" alt="{{thumbnail}}">
                    <p>Precio: {{price}}</p>
                    <p>Descripción: {{description}}</p>
                    <p>Código: {{code}}</p>
                    <p>Categoría: {{category}}</p>
                    <p>Stock: {{stock}}</p>
                    <p>ID: {{_id}}</p>
                    <button onclick="addToCart('{{_id}}')">Agregar al carrito</button>
                </li>
            {{/each}}
        {{else}}
            <p>No hay productos disponibles</p>
        {{/if}}
    </ul>

    <!-- Paginación -->
    <div>
        {{#if hasPrevPage}}
            <a href="/api/products/products?page={{prevPage}}&limit={{limit}}">Página Anterior</a>
        {{else}}
            <p>No hay página anterior</p>
        {{/if}}
        {{#if hasNextPage}}
            <a href="/api/products/products?page={{nextPage}}&limit={{limit}}">Página Siguiente</a>
        {{else}}
            <p>No hay página siguiente</p>
        {{/if}}
    </div>
</div>

<script>

    function getCartId() {
    return fetch('/api/carts/current') // Asegúrate de que esta ruta devuelve el ID del carrito correctamente
        .then(response => response.json())
        .then(data => {
            if (data.cartId && data.cartId.length === 24) {
                return data.cartId;
            } else {
                throw new Error('ID del carrito inválido');
            }
        })
        .catch(error => console.error('Error:', error));
}

function addToCart(pid) {
    getCartId().then(cid => {
        if (cid) {
            console.log('no entra al addtocart')
            fetch(`/api/carts/${cid}/product/${pid}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => alert(data.message))
                .catch(error => console.error('Error:', error));
        } else {
            console.error('Carrito no encontrado');
        }
    });
}


  function createCart() {
    fetch('/api/carts', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al crear el carrito');
            }
            return response.json();
        })
        .then(data => {
            alert('Carrito creado con éxito');
            // Aquí podrías actualizar el UI o hacer alguna acción
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message === 'Sesión no válida o expirada') {
                window.location.href = '/login'; // Redirige solo si es necesario
            }
        });
}
</script>